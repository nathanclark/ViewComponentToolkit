name: Run All Tests

on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ '**' ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ruby-version: ['3.3']

    steps:
    - uses: actions/checkout@v3
    - name: Set up Ruby ${{ matrix.ruby-version }}
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ matrix.ruby-version }}
        bundler-cache: true
    - name: Install dependencies
      run: bundle install
    - name: Run tests
      run: |
        bundle exec rake test | tee test_output.log
        echo "TEST_RESULTS=$(grep -oP '(\d+) assertions, \d+ errors, \d+ failures, \d+ skips' test_output.log)" >> $GITHUB_ENV
    - name: Create test results badge
      uses: schneegans/dynamic-badges-action@v1.6.0
      with:
        auth: ${{ secrets.GIST_SECRET }}
        gistID: ac922546bfc70590e78705eeeaaa0c76
        filename: test_results.json
        label: Tests
        message: ${{ env.TEST_RESULTS }}
        color: green